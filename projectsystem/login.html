<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="login.css">
<link rel="stylesheet" href="shared.css">
<title>C4S Payroll - Login</title>
<link rel="icon" type="image/png" href="src/logo-nobg.png">
</head>
<body>
<div class="animated-background"></div>
<div class="login-wrapper">
  <div class="user-icon">
    <img src="src/logo.png" alt="Logo" class="logo-img">
  </div>
  <div class="container" id="login-form">
    <h2>Login</h2>
    <form id="loginForm">
      <div class="input-wrapper">
        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 6L12 13L2 6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input type="text" id="login-email" name="login-email" placeholder="Email or Username" required />
      </div>

      <div class="input-wrapper">
        <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M7 11V7C7 4.23858 9.23858 2 12 2C14.7614 2 17 4.23858 17 7V11" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input type="password" id="login-password" name="login-password" placeholder="Password" required />
      </div>

      <button type="submit">LOGIN</button>
    </form>

    <div id="message" style="margin-top:12px;text-align:center;font-size:14px;padding:10px;border-radius:8px;display:none;"></div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="supabase.min.js"></script>
<script src="supabase-config.js"></script>
<script src="supabase-db.js"></script>
<script src="shared-utils.js"></script>

<script>
// Message display
function showMessage(text, isError) {
  var msgEl = document.getElementById('message');
  if (msgEl) {
    msgEl.textContent = text;
    msgEl.style.display = 'block';
    msgEl.style.background = isError ? 'rgba(239,68,68,0.9)' : 'rgba(16,185,129,0.9)';
    msgEl.style.color = '#fff';
  }
  if (isError && window.toastError) {
    try { toastError('Error', text); } catch(e) {}
  } else if (!isError && window.toastSuccess) {
    try { toastSuccess('Success', text); } catch(e) {}
  }
}

document.querySelector('#loginForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  var emailOrUsername = document.getElementById('login-email').value.trim().toLowerCase();
  var password = document.getElementById('login-password').value;
  var submitBtn = this.querySelector('button[type="submit"]');

  // Add loading state
  if (window.setButtonLoading) setButtonLoading(submitBtn, true);

  try {
    // Check for admin credentials
    if (emailOrUsername === 'admin' && password === '0304') {
      localStorage.setItem('currentEmployeeId', 'ADMIN');
      localStorage.setItem('currentEmployeeName', 'Admin');
      localStorage.setItem('isAdmin', 'true');

      if (window.setButtonLoading) setButtonLoading(submitBtn, false);
      showMessage('Welcome, Admin! Redirecting...', false);

      setTimeout(function() {
        window.location.href = 'admin_dashboard.html';
      }, 800);
      return;
    }

    // Query Supabase for employee
    const { data: employee, error } = await supabaseClient
      .from('employees')
      .select('*')
      .or(`email.eq.${emailOrUsername},username.eq.${emailOrUsername}`)
      .eq('status', 'active')
      .single();

    if (error || !employee) {
      throw new Error('Invalid email/username or password');
    }

    // Check password
    if (employee.password_hash !== password) {
      throw new Error('Invalid email/username or password');
    }

    // Store session info
    localStorage.setItem('currentEmployeeId', employee.id);
    localStorage.setItem('currentEmployeeName', employee.name);
    localStorage.setItem('isAdmin', 'false');

    if (window.setButtonLoading) setButtonLoading(submitBtn, false);
    showMessage('Welcome, ' + employee.name + '! Redirecting...', false);

    setTimeout(function() {
      window.location.href = 'employee_dashboard.html';
    }, 800);

  } catch (err) {
    console.error('Login error:', err);
    if (window.setButtonLoading) setButtonLoading(submitBtn, false);
    showMessage(err.message || 'Invalid email/username or password', true);
  }
});
</script>
</body>
</html>
